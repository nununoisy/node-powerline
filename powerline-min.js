const Module=require("module"),fs=require("fs"),exists=fs.existsSync;var _require=Module.prototype.require;const SAVE_FILENAME=__dirname+"/cache.dat";var nameCache=exists(SAVE_FILENAME)?JSON.parse(fs.readFileSync(SAVE_FILENAME,"utf-8")):{};Module.prototype.require=function(e){var r,t=nameCache[this.filename];return t||(t={},nameCache[this.filename]=t),t[e]?r=t[e]:(r=Module._resolveFilename(e,this),t[e]=r),_require.call(this,r)};const async=require("async");try{var config=JSON.parse(fs.readFileSync(__dirname+"/powerline-cfg.json"))}catch(e){throw new Error("Couldn't read configuration file due to "+e.name+" - "+e.message)}const out=e=>{process.stdout.write(e)};"256"!=process.argv[4]&&(config.colors256=!1);var bgc=config.colors256?config.colors.bg:config.colorssx.bg,fgc=config.colors256?config.colors.fg:config.colorssx.fg;const readTerminalProcess=(e,r,t)=>{const{spawnSync:s}=require("child_process");return s(e,r,{input:t})};var left=[],right=[];const addSegment=(e,r,t,s,o,n,c)=>{if(!e||""===e)throw new SyntaxError("Contents must not be empty");if("left"===r)t.toString()&&left.push("c{bg"+t+"}"),s.toString()&&left.push("c{fg"+s+"}"),left.push(e),o&&left.push("c{t}"),n&&left.push("c{st}");else{if("right"!==r)throw new SyntaxError("align must be 'left' or 'right'");n&&right.push("c{st}"),o&&right.push("c{t}"),t&&right.push("c{bg"+t+"}"),s&&right.push("c{fg"+s+"}"),right.push(e)}},parseColor=e=>{if(-1===e.indexOf("c{"))throw new SyntaxError("No command found");return e.replace(/c{(b|f)g/g,"").replace(/}/g,"")},color16=(e,r)=>{if((e=parseInt(e))>15)throw new Error("Color is not 16 bit");if(e<0)throw new Error("Invalid color");let t="",s=0,o=r?10:0;return e>=8?(t=";1",s=22+e+o):s=30+e+o,s+t};"DEBUG"==process.argv[3]&&(console.log(bgc,fgc),console.log(color16(12,!0),color16(12,!1)),process.exit());const writeColors=(e,r,t)=>{!1===t&&out("\\["),config.colors256?out("[48;5;"+e+"m[38;5;"+r+"m"):out("["+color16(e,!0)+"m["+color16(r,!1)+"m"),!1===t&&out("\\]")},clearColors=e=>{out((e?"":"\\[")+"[0m"+(e?"":"\\]"))};var colorRegex=/^c{(b|f)g[0-9]{1,3}}$/,seglength=0;const trackLength=e=>{let r=e.replace(/(\\\[|\\\])/g,"");seglength+=r.length,out(r)},drawSegments=(e,r,t)=>{if(!t&&0!==r.length)throw new SyntaxError("Right-aligned segments not allowed in prompt");var s,o,n,c;if(n=bgc.termdefault,c=fgc.termdefault,t){var a=process.argv[3];for(seglength=0,clearColors(!0),s=0;s<e.length;s++)"c{t}"==(o=e[s])?(trackLength(" "),c=n,s+1===e.length?(writeColors(bgc.immersebar,c,!0),trackLength(config.unicodechars.arrows.solidright)):c===(n=parseColor(e[s+1]))?trackLength(config.unicodechars.arrows.right):(writeColors(n,c,!0),trackLength(config.unicodechars.arrows.solidright))):"c{st}"===o?trackLength(" "+config.unicodechars.arrows.right):colorRegex.test(o)?(-1===o.indexOf("bg")?c=parseColor(o):n=parseColor(o),writeColors(n,c,!0),trackLength(-1!==o.indexOf("bg")?" ":"")):"c{important}"===o||trackLength(o);let t=0;for(s=0;s<r.length;s++)"c{t}"===(o=r[s])||"c{st}"===o?t+=2:-1!==o.indexOf("c{bg")?t++:-1===o.indexOf("c{fg")&&"c{important}"!==o&&(t+=o.length);for(writeColors(bgc.immersebar,c,!0),s=1;s<a-seglength-t;s++)out(" ");for(s=0;s<r.length;s++)if("c{t}"==(o=r[s]))c=n,0===s?(c=parseColor(r[1]),n=bgc.immersebar,writeColors(n,c,!0),out(config.unicodechars.arrows.solidleft)):c===(n=parseColor(r[s+1]))?out(" "+config.unicodechars.arrows.left):(writeColors(n,c,!0),out(" "+config.unicodechars.arrows.solidleft));else if("c{st}"===o)out(" "+config.unicodechars.arrows.left);else if(colorRegex.test(o))-1===o.indexOf("bg")?c=parseColor(o):n=parseColor(o),writeColors(n,c,!0),out(-1!==o.indexOf("bg")?" ":"");else if("c{important}"===o);else{if(!o)throw new Error("Error at index "+s);out(o)}out(" "),clearColors(!0)}else{for(s=0;s<e.length;s++)"c{t}"==(o=e[s])?(out(" "),c=n,s+1===e.length?(clearColors(!1),out(config.colors256?"\\[[38;5;"+c+"m\\]":"\\[["+color16(c,!1)+"m\\]"),out(config.unicodechars.arrows.solidright)):c===(n=parseColor(e[s+1]))?out(config.unicodechars.arrows.right):(writeColors(n,c,!1),out(config.unicodechars.arrows.solidright))):"c{st}"===o?out(" "+config.unicodechars.arrows.right):colorRegex.test(o)?(-1===o.indexOf("bg")?c=parseColor(o):n=parseColor(o),writeColors(n,c,!1),out(-1!==o.indexOf("bg")?" ":"")):"c{important}"===o||out(o);clearColors(!1),out(" ")}},stripNewlines=e=>e.toString().replace(/\r?\n|\r/g,"");var paren=/.*\(.*\).*/g,defaultSegments={exitcode:e=>{var r="left";e.a&&(r=e.a);var t="err";e.c&&(t=e.c);var s="check";e.c2&&(s=e.c2);var o=parseInt(process.argv[2],10);if(isNaN(o))throw new Error("No exitcode passed");0===o?addSegment(config.unicodechars.check,r,bgc[s],fgc[s],!0,!1):addSegment(config.unicodechars.err+" "+o+(o!=config.segments.segconfig.exitcode.codes.default[o]?": "+config.segments.segconfig.exitcode.codes.default[o]:""),r,bgc[t],fgc[t],!0,!1)},user:e=>{var r="left";e.a&&(r=e.a);var t="user";e.c&&(t=e.c);var s=readTerminalProcess("whoami",[],"");addSegment(stripNewlines(s.stdout),r,bgc[t],fgc[t],!0,!1)},dir:e=>{var r="left";e.a&&(r=e.a);var t="dir";e.c&&(t=e.c);var s=config.segments.segconfig.dirlength,o=stripNewlines(readTerminalProcess("pwd",[],"").stdout);const n=require("os").homedir();(o=o.replace(n,"~")).length>s&&(o=config.unicodechars.dotdotdot+o.slice(-(s-1))),o.split("/").forEach((e,s,o)=>{if(""!==e){var n=s+1===o.length;addSegment(e,r,bgc[t],fgc[t],n,!n)}})},promptcharacter:e=>{var r="left";e.a&&(r=e.a);var t="user";e.c&&(t=e.c);var s=parseInt(stripNewlines(readTerminalProcess("id",["-u"],"").stdout),10);addSegment(0===s?"#":"$",r,bgc[t],fgc[t],!0,!1)},datetime:e=>{var r="left";e.a&&(r=e.a);var t="dir";e.c&&(t=e.c);var s=stripNewlines(readTerminalProcess("date",["+"+config.segments.segconfig.datefmt],"").stdout),o=stripNewlines(readTerminalProcess("date",["+"+config.segments.segconfig.timefmt],"").stdout);addSegment(s,r,bgc[t],fgc[t],!1,!0),addSegment(o,r,bgc[t],fgc[t],!0,!1)},gitCompile:e=>{var r="left";e.a&&(r=e.a);e.c&&(r=e.c);let t=[];""!==defaultSegments.git.getBranchName()&&(config.segments.segconfig.gitsegments.forEach(e=>{if(paren.test(e))throw new Error("Cannot add arguments to individual gitsegments. Fix gitsegment "+e);t.push(new Function("c","global."+e+"('"+r+"','git');"))}),async.parallel(t))},battery:e=>{var r="left";e.a&&(r=e.a);e.c&&(r=e.c);var t,s,o=config.segments.segconfig.battery.customfile?config.segments.segconfig.battery.customfile:"/sys/class/power_supply/BAT"+config.segments.segconfig.battery.batno+"/uevent";fs.readFileSync(o).toString().split("\n").forEach(e=>{-1!==e.indexOf("POWER_SUPPLY_CAPACITY=")&&(t=e.replace("POWER_SUPPLY_CAPACITY=","")),-1!==e.indexOf("POWER_SUPPLY_STATUS=")&&(s=e.replace("POWER_SUPPLY_STATUS=",""))});let n=parseFloat(t,10)/10;if(!(n=(n=n<=10?n:10)>0?n:.1)||!s)throw new Error("Invalid battery file");var c=Math.round(8*n)/8,a=Math.floor(c);a===c?(10!==a&&a++,c=0):c-=a;var i=9-a;i=i>=0?i:0;var g="";let l;for(l=0;l<a;l++)g+=config.unicodechars.battery.fractionblocks[0];for(0!==c&&(g+=config.unicodechars.battery.fractionblocks[8-8*c]),l=0;l<i;l++)g+=" ";let f="Charging"===s?config.unicodechars.battery.bolt+" ":"";addSegment(f+(10*n).toString()+"%",r,bgc.dir,fgc.dir,!0,!1);let d=config.segments.segconfig.battery.indicator.normal,u=config.segments.segconfig.battery.indicator.low,m=t>config.segments.segconfig.battery.indicator.lowthreshold?d:u;addSegment(g,r,bgc.dir,bgc[m],!0,!1)},git:{getBranchName:()=>stripNewlines(readTerminalProcess("git",["rev-parse","--abbrev-ref","HEAD"],"").stdout),branch:(e,r)=>{var t=defaultSegments.git.getBranchName();addSegment(config.unicodechars.gitbranch+" "+t,e,bgc[r],fgc[r],!0,!1)},commits:(e,r)=>{var t=stripNewlines(readTerminalProcess("git",["rev-parse","--abbrev-ref","HEAD"],"").stdout),s=stripNewlines(readTerminalProcess("git",["rev-list","--left-right","--count","origin/"+t+"..."+t],"").stdout).split("\t"),o=parseInt(s[1],10),n=parseInt(s[0],10);if(0===o&&0===n)addSegment(config.unicodechars.arrows.up+config.unicodechars.arrows.down+config.unicodechars.check,e,bgc[r],fgc[r],!0,!1);else{var c="";0!==o&&(c+=config.unicodechars.arrows.up+" "+o),0!==n&&(c+=config.unicodechars.arrows.down+" "+n),addSegment(c,e,bgc[r],fgc[r],!0,!1)}},tag:(e,r)=>{var t=readTerminalProcess("git",["describe","--tags"],"");if(""===t.stderr.toString()){var s=stripNewlines(t.stdout);addSegment(s,e,bgc[r],fgc[r],!0,!1)}},conflicts:(e,r)=>{if(""!==stripNewlines(readTerminalProcess("git",["ls-files","--unmerged"],"").stdout))var t=config.unicodechars.err;else t=config.unicodechars.check;addSegment(t,e,bgc[r],fgc[r],!0,!1)},tracking:(e,r)=>{var t=readTerminalProcess("git",["diff","--numstat"]).stdout.toString(),s=readTerminalProcess("git",["diff","--cached","--numstat"]).stdout.toString(),o=t.split(/\r\n|\r|\n/).length-1,n=s.split(/\r\n|\r|\n/).length-1,c="";0===o&&0===n||(0!==o&&(c+="U "+o),0!==n&&(c+=(0!==o?" ":"")+"C "+n),addSegment(c,e,bgc[r],fgc[r],!0,!1))},stash:(e,r)=>{var t=readTerminalProcess("git",["stash","list"],"").stdout.toString().split(/\r\n|\r|\n/).length-1;0!==t&&addSegment(config.unicodechars.flag+" "+t,e,bgc[r],fgc[r],!0,!1)}},literal:(e,r)=>{var t="left";e.a&&(t=e.a);var s="dir";e.c&&(s=e.c);e.c2&&(s=e.c2),addSegment(r,t,bgc[s],fgc[s],!0,!1)}};global.defaultSegments=defaultSegments;const loadAddons=()=>{config.addons.forEach(e=>{require(__dirname+"/addons/"+e)(global)})};config.addons.length>0&&config.addons.forEach(e=>{require(__dirname+"/addons/"+e)(global)});var ps1=[],ps2=[],ps0=[],immersebar=[];const parseSegmentDefs=()=>{ps1=config.segments.ps1,ps2=config.segments.ps2,config.segments.ps0enabled&&(ps0=config.segments.ps0),immersebar=config.segments.immersebar};var segFuncs=[];const runSegmentNameFunction=e=>{segFuncs.push(new Function("c","global."+e+(-1!==e.indexOf("(")?";":"({});")))},chooseSegments=()=>{var e=process.argv[3];switch(parseSegmentDefs(),e){case"PS0":ps0.length>0&&config.segments.ps0enabled?(ps0.forEach(runSegmentNameFunction),async.parallel(segFuncs),drawSegments(left,[],!1)):out(process.env.PS0||"");break;case"PS1":ps1.length>0?(ps1.forEach(runSegmentNameFunction),async.parallel(segFuncs),drawSegments(left,[],!1)):out(process.env.PS1||"");break;case"PS2":ps2.length>0?(ps2.forEach(runSegmentNameFunction),async.parallel(segFuncs),drawSegments(left,[],!1)):out(process.env.PS2||"");break;case"MULTI":ps0.length>0&&config.segments.ps0enabled&&(ps0.forEach(runSegmentNameFunction),async.parallel(segFuncs),out('PS0="'),drawSegments(left,[],!1),out('"; '),segFuncs=[],left=[]),ps1.length>0&&(ps1.forEach(runSegmentNameFunction),async.parallel(segFuncs),out('PS1="'),drawSegments(left,[],!1),out('"; '),segFuncs=[],left=[]),ps2.length>0&&(ps2.forEach(runSegmentNameFunction),async.parallel(segFuncs),out('PS2="'),drawSegments(left,[],!1),out('"; '),segFuncs=[],left=[]);break;default:throw new Error("Invalid or blank segment mode")}process.exit(process.argv[2])},immerseDraw=()=>{parseSegmentDefs(),immersebar.forEach(runSegmentNameFunction),async.parallel(segFuncs),drawSegments(left,right,!0)};"-b"===process.argv[2]?(parseSegmentDefs(),immersebar.forEach(runSegmentNameFunction),async.parallel(segFuncs),drawSegments(left,right,!0)):chooseSegments();